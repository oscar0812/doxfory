// Current as of 06-16-14
!function(e){function t(){var e=document.createElement("input"),t="onpaste";return e.setAttribute(t,""),"function"==typeof e[t]?"paste":"input"}var n,a=t()+".mask",r=navigator.userAgent,i=/iphone/i.test(r),o=/chrome/i.test(r),c=/android/i.test(r);e.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},autoclear:!0,dataName:"rawMaskFn",placeholder:"_"},e.fn.extend({caret:function(e,t){var n;if(0!==this.length&&!this.is(":hidden"))return"number"==typeof e?(t="number"==typeof t?t:e,this.each(function(){this.setSelectionRange?this.setSelectionRange(e,t):this.createTextRange&&(n=this.createTextRange(),n.collapse(!0),n.moveEnd("character",t),n.moveStart("character",e),n.select())})):(this[0].setSelectionRange?(e=this[0].selectionStart,t=this[0].selectionEnd):document.selection&&document.selection.createRange&&(n=document.selection.createRange(),e=0-n.duplicate().moveStart("character",-1e5),t=e+n.text.length),{begin:e,end:t})},unmask:function(){return this.trigger("unmask")},mask:function(t,r){var l,u,s,f,h,m;return!t&&this.length>0?(l=e(this[0]),l.data(e.mask.dataName)()):(r=e.extend({autoclear:e.mask.autoclear,placeholder:e.mask.placeholder,completed:null},r),u=e.mask.definitions,s=[],f=m=t.length,h=null,e.each(t.split(""),function(e,t){"?"==t?(m--,f=e):u[t]?(s.push(new RegExp(u[t])),null===h&&(h=s.length-1)):s.push(null)}),this.trigger("unmask").each(function(){function l(e){for(;++e<m&&!s[e];);return e}function d(e){for(;--e>=0&&!s[e];);return e}function p(e,t){var n,a;if(!(0>e)){for(n=e,a=l(t);m>n;n++)if(s[n]){if(!(m>a&&s[n].test(S[a])))break;S[n]=S[a],S[a]=r.placeholder,a=l(a)}x(),A.caret(Math.max(h,e))}}function v(e){var t,n,a,i;for(t=e,n=r.placeholder;m>t;t++)if(s[t]){if(a=l(t),i=S[t],S[t]=n,!(m>a&&s[a].test(i)))break;n=i}}function g(){R(),A.val()!=j&&A.change()}function k(e){var t,n,a,r=e.which;8===r||46===r||i&&127===r?(t=A.caret(),n=t.begin,a=t.end,a-n===0&&(n=46!==r?d(n):a=l(n-1),a=46===r?l(a):a),y(n,a),p(n,a-1),e.preventDefault()):13===r?g.call(this,e):27===r&&(A.val(j),A.caret(0,R()),e.preventDefault())}function b(t){var n,a,i,o=t.which,u=A.caret();if(0==o){if(u.begin>=m)return A.val(A.val().substr(0,m)),t.preventDefault(),!1;u.begin==u.end&&(o=A.val().charCodeAt(u.begin-1),u.begin--,u.end--)}if(!(t.ctrlKey||t.altKey||t.metaKey||32>o)&&o&&13!==o){if(u.end-u.begin!==0&&(y(u.begin,u.end),p(u.begin,u.end-1)),n=l(u.begin-1),m>n&&(a=String.fromCharCode(o),s[n].test(a))){if(v(n),S[n]=a,x(),i=l(n),c){var f=function(){e.proxy(e.fn.caret,A,i)()};setTimeout(f,0)}else A.caret(i);r.completed&&i>=m&&r.completed.call(A)}t.preventDefault()}}function y(e,t){var n;for(n=e;t>n&&m>n;n++)s[n]&&(S[n]=r.placeholder)}function x(){A.val(S.join(""))}function R(e){var t,n,a,i=A.val(),o=-1;for(t=0,a=0;m>t;t++)if(s[t]){for(S[t]=r.placeholder;a++<i.length;)if(n=i.charAt(a-1),s[t].test(n)){S[t]=n,o=t;break}if(a>i.length)break}else S[t]===i.charAt(a)&&t!==f&&(a++,o=t);return e?x():f>o+1?r.autoclear||S.join("")===T?(A.val()&&A.val(""),y(0,m)):x():(x(),A.val(A.val().substring(0,o+1))),f?t:h}var A=e(this),S=e.map(t.split(""),function(e){return"?"!=e?u[e]?r.placeholder:e:void 0}),T=S.join(""),j=A.val();A.data(e.mask.dataName,function(){return e.map(S,function(e,t){return s[t]&&e!=r.placeholder?e:null}).join("")}),A.attr("readonly")||A.one("unmask",function(){A.off(".mask").removeData(e.mask.dataName)}).on("focus.mask",function(){clearTimeout(n);var e;j=A.val(),e=R(),n=setTimeout(function(){x(),e==t.replace("?","").length?A.caret(0,e):A.caret(e)},10)}).on("blur.mask",g).on("keydown.mask",k).on("keypress.mask",b).on(a,function(){setTimeout(function(){var e=R(!0);A.caret(e),r.completed&&e==A.val().length&&r.completed.call(A)},0)}),o&&c&&A.on("keyup.mask",b),R()}))}})}(jQuery);
